
# Заметка по SSH-ключам: Правильная организация

Эта заметка описывает правильный подход к управлению SSH-ключами: создание отдельных ключей для разных задач и настройка SSH-клиента для их автоматического использования.

## Часть 1: Настройка локального подключения (Машина 1 -> Машина 2)

> [!TIP] Цель  
> Настроить удобное и безопасное подключение между двумя моими Arch-машинами в локальной сети, не затрагивая существующие ключи для GitHub.

### Шаг 1: Создание выделенного ключа для локальной сети

На **Машине 1** (с которой будем подключаться) создаем новый ключ специально для этой задачи.

Generated bash

```
# Флаг -f задает уникальное имя файла, чтобы не перезаписать существующие ключи
# Флаг -C добавляет понятный комментарий
ssh-keygen -t ed25519 -f ~/.ssh/arch_local_key -C "Локальный ключ для связи между Arch-машинами"
```


На вопросы о passphrase (кодовая фраза) просто нажимаем Enter, чтобы для подключения не нужно было вводить пароль.

### Шаг 2: Настройка SSH-клиента для удобного подключения

Чтобы не вводить длинные команды, настроим псевдоним (alias) в конфигурационном файле SSH.

1. Открываем файл ~/.ssh/config (если его нет, команда его создаст):
    
    Generated bash
    
    ```
    micro ~/.ssh/config
    ```
    
    
2. Добавляем в него следующий блок, заменив IP_АДРЕС_МАШИНЫ_2 и ЛОГИН_НА_МАШИНЕ_2 на реальные данные:
    
    Generated ini
    
    ```
    # ==================================
    # Конфигурация для локальной машины
    # ==================================
    Host arch-server
      HostName IP_АДРЕС_МАШИНЫ_2
      User ЛОГИН_НА_МАШИНЕ_2
      IdentityFile ~/.ssh/arch_local_key
      IdentitiesOnly yes
    ```

    
    > [!INFO] Что означают эти строки?
    > 
    > - Host arch-server: Мы создали короткое имя arch-server для подключения.
    >     
    > - HostName: Реальный IP-адрес или доменное имя сервера.
    >     
    > - User: Имя пользователя на удаленной машине.
    >     
    > - IdentityFile: Указывает, какой именно **приватный** ключ использовать для этого подключения.
    >     
    > - IdentitiesOnly yes: Запрещает SSH пробовать другие ключи, если этот не подошел.
    >     
    

### Шаг 3: Копирование ключа на удаленную машину

Копируем наш новый **публичный** ключ (arch_local_key.pub) на **Машину 2**.

### Правильный порядок действий:

1. Вы находитесь за **Машиной 1**. Ваш терминал выглядит примерно так:
    
    Generated code
    
    ```
    [hyrip@machine1 ~]$
    ```
        
    Вы **НЕ** подключены к Машине 2.
    
2. Именно в этом терминале (на Машине 1) вы вводите команду:
    
    Generated bash
    
    ```
    ssh-copy-id -i ~/.ssh/arch_local_key.pub arch-server
    ```
       
3. **Что произойдет дальше?**
    
    - ssh-copy-id прочитает ваш публичный ключ arch_local_key.pub.
        
    - Затем она сама инициирует **новое SSH-соединение** с хостом arch-server.
        
    - Поскольку ключа на сервере еще нет, сервер запросит у ssh-copy-id пароль.
        
    - ssh-copy-id передаст этот запрос вам в терминал. Вы увидите знакомое:
        
        Generated code
        
        ```
        /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
        /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
        ЛОГИН_НА_МАШИНЕ_2@IP_АДРЕС_МАШИНЫ_2's password:
        ```
            
    - Вы вводите пароль от **Машины 2** и нажимаете Enter.
        
4. После ввода правильного пароля ssh-copy-id успешно войдет на Машину 2, добавит ваш публичный ключ в файл ~/.ssh/authorized_keys, выставит правильные права доступа и завершит свою работу.

Generated bash

```
ssh-copy-id -i ~/.ssh/arch_local_key.pub arch-server
```


> [!NOTE]  
> Мы используем псевдоним arch-server, который мы только что создали. Утилита ssh-copy-id возьмет из конфига IP-адрес и логин. Вас попросят в последний раз ввести пароль для авторизации операции копирования.

### Шаг 4: Проверка

Теперь с **Машины 1** можно подключаться к Машине 2 очень простой командой:

Generated bash

````
ssh arch-server```
Подключение должно произойти мгновенно и без запроса пароля.

---
---

## Часть 2: План по обновлению ключей для Git-сервисов (Сделать позже)

> [!WARNING] Предыстория
> Сейчас у меня один SSH-ключ используется для доступа ко всем Git-репозиториям (GitHub, GitLab, Bitbucket). Это работает, но менее безопасно. Этот план описывает, как создать для каждого сервиса свой собственный ключ и настроить SSH для автоматического выбора нужного.

### Шаг А: Генерация новых, отдельных ключей для каждого сервиса

На главной машине создаем по одному ключу для каждого сервиса, давая им понятные имена.

```bash
# Ключ для GitHub
ssh-keygen -t ed25519 -f ~/.ssh/github_key -C "Ключ для GitHub (моя_почта@example.com)"

# Ключ для GitLab
ssh-keygen -t ed25519 -f ~/.ssh/gitlab_key -C "Ключ для GitLab (моя_почта@example.com)"

# Ключ для Bitbucket
ssh-keygen -t ed25519 -f ~/.ssh/bitbucket_key -C "Ключ для Bitbucket (моя_почта@example.com)"
````


### Шаг Б: Полное обновление конфигурационного файла SSH

1. **Сделайте резервную копию** текущего файла ~/.ssh/config:
    
    Generated bash
    
    ```
    cp ~/.ssh/config ~/.ssh/config.bak
    ```
    
    
2. Откройте ~/.ssh/config и **полностью замените его содержимое** на текст ниже. Он включает в себя конфигурацию для всех новых ключей, а также уже существующую для локальной сети.
    
    Generated ini
    
    ```
    # ==================================
    # Конфигурация для GitHub
    # ==================================
    Host github.com
      HostName github.com
      User git
      IdentityFile ~/.ssh/github_key
      IdentitiesOnly yes
    
    # ==================================
    # Конфигурация для GitLab
    # ==================================
    Host gitlab.com
      HostName gitlab.com
      User git
      IdentityFile ~/.ssh/gitlab_key
      IdentitiesOnly yes
    
    # ==================================
    # Конфигурация для Bitbucket
    # ==================================
    Host bitbucket.org
      HostName bitbucket.org
      User git
      IdentityFile ~/.ssh/bitbucket_key
      IdentitiesOnly yes
    
    # ==================================
    # Конфигурация для локальной машины (уже настроена)
    # ==================================
    Host arch-server
      HostName IP_АДРЕС_МАШИНЫ_2
      User ЛОГИН_НА_МАШИНЕ_2
      IdentityFile ~/.ssh/arch_local_key
      IdentitiesOnly yes
    ```
    
    

### Шаг В: Загрузка новых публичных ключей на сервисы

Для каждого сервиса нужно скопировать содержимое его нового .pub файла и вставить в настройках SSH-ключей на соответствующем сайте.

1. **Для GitHub:**
    
    Generated bash
    
    ```
    cat ~/.ssh/github_key.pub
    # Скопировать вывод и вставить на GitHub: Settings -> SSH and GPG keys -> New SSH key
    ```

    
2. **Для GitLab:**
    
    Generated bash
    
    ```
    cat ~/.ssh/gitlab_key.pub
    # Скопировать вывод и вставить на GitLab: Preferences -> SSH Keys
    ```
   
    
3. **Для Bitbucket:**
    
    Generated bash
    
    ```
    cat ~/.ssh/bitbucket_key.pub
    # Скопировать вывод и вставить на Bitbucket: Personal settings -> SSH keys
    ```
    
    

### Шаг Г: Финальная проверка и очистка

1. Проверьте, что доступ ко всем сервисам работает, например, командой ssh -T git@github.com.
    
2. **После успешной проверки** можно зайти в настройки каждого сервиса и **удалить старый, общий SSH-ключ**, чтобы остался только новый, выделенный.
    
3. Также можно удалить старый файл приватного ключа с локальной машины, чтобы не было путаницы.