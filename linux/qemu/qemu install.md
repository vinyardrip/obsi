

# Настройка KVM/QEMU с пробросом GPU NVIDIA для NixOS в Arch Linux (Hyprland)

**Теги:** #linux #virtualization #vfio #qemu #kvm #archlinux #nixos #nvidia #hyprland

Это пошаговое руководство по настройке виртуальной машины с NixOS и пробросом (passthrough) видеокарты NVIDIA. Хост-система — Arch Linux с оконным композитором Hyprland.

> [!WARNING] Внимание!  
> Проброс единственной видеокарты (Single GPU Passthrough) — сложная задача. Хост-система потеряет доступ к GPU после запуска ВМ, что приведет к черному экрану. Убедитесь, что у вас настроен доступ к хосту по SSH, или используйте вторую видеокарту (даже интегрированную) для хост-системы.

---

## Шаг 1: Установка и настройка KVM, QEMU и Libvirt

Сначала подготовим хост-систему (Arch Linux), установив все необходимые пакеты для виртуализации.

### 1.1. Установка пакетов

codeBash

```
sudo pacman -S qemu-full virt-manager virt-viewer dnsmasq vde2 bridge-utils openbsd-netcat ebtables iptables libguestfs edk2-ovmf
```

- qemu-full: Эмулятор и виртуализатор.
    
- virt-manager: Графический интерфейс для управления ВМ.
    
- edk2-ovmf: Прошивка UEFI для ВМ, необходима для проброса GPU.
    

### 1.2. Запуск службы libvirtd

codeBash

```
sudo systemctl enable --now libvirtd.service
```

### 1.3. Добавление пользователя в группу libvirt

Это позволит вам управлять ВМ без sudo.

codeBash

````
sudo usermod -aG libvirt $(whoami)
```> [!NOTE] После выполнения этой команды необходимо **выйти из системы и снова войти** или перезагрузить компьютер.

---

## Шаг 2: Включение IOMMU и изоляция GPU

Это самый важный этап. Он позволяет изолировать видеокарту от хост-системы для передачи ее в ВМ.

### 2.1. Включение IOMMU в BIOS/UEFI

1.  Перезагрузите компьютер и войдите в настройки BIOS/UEFI.
2.  Найдите и включите опции виртуализации:
    *   **Для Intel:** `Intel VT-d`, `Intel Virtualization Technology`.
    *   **Для AMD:** `AMD-Vi`, `IOMMU`, `SVM`.
3.  Сохраните изменения и перезагрузитесь.

### 2.2. Активация IOMMU в ядре Linux

1.  Отредактируйте конфигурацию загрузчика GRUB:
    ```bash
    sudo nano /etc/default/grub
    ```
2.  Добавьте параметр в строку `GRUB_CMDLINE_LINUX_DEFAULT`:
    *   **Для Intel:** `intel_iommu=on`
    *   **Для AMD:** `amd_iommu=on`

    *Пример для Intel:*
    ```diff
    - GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
    + GRUB_CMDLINE_LINUX_DEFAULT="quiet splash intel_iommu=on"
    ```
3.  Обновите конфигурацию GRUB и **перезагрузите компьютер**:
    ```bash
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    sudo reboot
    ```

### 2.3. Изоляция видеокарты от хоста

1.  **Найдите ID вашей видеокарты.** Выполните команду и найдите вашу NVIDIA GPU и ее аудиоустройство (HD Audio Controller).
    ```bash
    lspci -nnk
    ```
    Вывод будет выглядеть примерно так (ID выделены):
    `01:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU104 [GeForce RTX 2070 SUPER] [**10de:1e84**]`
    `01:00.1 Audio device [0403]: NVIDIA Corporation TU104 HD Audio Controller [**10de:10f8**]`

2.  **Укажите драйверу `vfio-pci` захватывать эти устройства.** Создайте файл:
    ```bash
    sudo nano /etc/modprobe.d/vfio.conf
    ```
    Добавьте в него строку с вашими ID:
    ```
    options vfio-pci ids=10de:1e84,10de:10f8
    ```
3.  **Пересоберите `initramfs`**, чтобы изменения применились на раннем этапе загрузки.
    ```bash
    sudo mkinitcpio -P
    ```
4.  **Перезагрузите компьютер.**

5.  **Проверьте результат.** После перезагрузки снова выполните `lspci -nnk`. Теперь у вашей видеокарты должен быть указан `Kernel driver in use: vfio-pci`.

---

## Шаг 3: Создание и настройка виртуальной машины

Теперь создадим ВМ в `virt-manager`.

1.  Запустите `virt-manager` из меню приложений или командой в терминале.
2.  Нажмите "Файл" -> "Создать виртуальную машину" (или иконку на панели).
3.  Выберите **"Локальный установочный носитель"** и укажите путь к ISO-образу NixOS.
4.  Выделите достаточное количество ОЗУ (минимум 8 ГБ) и ядер ЦП.
5.  Создайте виртуальный жесткий диск.
6.  **Очень важно:** на последнем шаге поставьте галочку **"Настроить конфигурацию перед установкой"**.
7.  В открывшемся окне настроек:
    *   **Обзор** -> Убедитесь, что "Микропрограмма" установлена в **UEFI x86_64**.
    *   **Процессор** -> Поставьте галочку "Копировать конфигурацию ЦП хоста".
    *   Удалите все виртуальные устройства отображения: **"Дисплей Spice"** и **"Видео QXL"**.
    *   Нажмите **"Добавить оборудование"** -> **"Устройство PCI хоста"**.
    *   Найдите и добавьте вашу видеокарту NVIDIA.
    *   Снова нажмите "Добавить оборудование" и добавьте аудиоустройство вашей видеокарты.

---

## Шаг 4: Установка и настройка NixOS

1.  Нажмите **"Начать установку"** в `virt-manager`. Изображение должно появиться на мониторе, подключенном к пробрасываемой видеокарте.
2.  Следуйте стандартной процедуре установки NixOS (разметка диска, генерация конфига).
3.  **Перед перезагрузкой** после установки, отредактируйте файл конфигурации NixOS:
    ```bash
    nano /mnt/etc/nixos/configuration.nix
    ```
4.  Добавьте в него строки для установки драйверов NVIDIA:
    ```nix
    # Включить OpenGL и драйверы NVIDIA
    services.xserver.videoDrivers = [ "nvidia" ];
    hardware.opengl.enable = true;
    
    # Рекомендуется для новых карт
    hardware.nvidia.modesetting.enable = true; 
    ```
5.  Сохраните файл и завершите установку. После перезагрузки NixOS должна запуститься с использованием проброшенной видеокарты.

---

## Шаг 5: Полезные советы и решение проблем

> [!TIP] Советы
> * **XML-конфигурация:** Вы всегда можете отредактировать XML-конфигурацию ВМ вручную через `virsh edit <имя_вм>` для тонкой настройки.
> * **Проброс USB:** Аналогично пробросу PCI, вы можете добавить USB-контроллер или отдельные USB-устройства в ВМ.
> * **Huge Pages:** Для улучшения производительности можно настроить Huge Pages.

> [!BUG] Возможные проблемы
> * **Черный экран в ВМ:** Убедитесь, что вы удалили виртуальные дисплеи (Spice, QXL). Проверьте, что монитор подключен к правильной видеокарте.
> * **Ошибка "Kernel driver in use: nvidia":** Если после перезагрузки драйвер `vfio-pci` не подхватился, убедитесь, что вы правильно обновили `initramfs` и перезагрузились.
> * **ВМ не запускается:** Проверьте логи в `/var/log/libvirt/qemu/`.

### Ссылки
- [[Arch Wiki - PCI passthrough via OVMF]]
- [[NixOS Wiki - NVIDIA]]
````