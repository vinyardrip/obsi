
# Настройка KVM/QEMU с пробросом NVIDIA GPU (Dual-GPU) для NixOS в Arch Linux

**Теги:** #linux #virtualization #vfio #qemu #kvm #archlinux #nixos #nvidia #hyprland #dual-gpu

Это полное руководство по настройке виртуальной машины (ВМ) с NixOS и пробросом второй видеокарты NVIDIA.

> [!INFO] Сценарий: Dual-GPU  
> У нас есть две видеокарты:
> 
> - **Основная GPU:** Используется хост-системой (Arch Linux + Hyprland). К ней подключен основной монитор.
>     
> - **Вторичная (гостевая) GPU:** Полностью игнорируется хостом и эксклюзивно передается гостевой ВМ (NixOS). К ней должен быть подключен второй монитор, либо один монитор с переключением входов.
>     

---

## Шаг 1: Подготовка хост-системы (Arch Linux)

### 1.1. Установка пакетов для виртуализации

codeBash

```
sudo pacman -S qemu-full virt-manager virt-viewer dnsmasq vde2 bridge-utils openbsd-netcat ebtables iptables libguestfs edk2-ovmf
```

- qemu-full: Эмулятор и виртуализатор.
    
- virt-manager: Графический интерфейс для управления ВМ.
    
- edk2-ovmf: Прошивка UEFI для ВМ, необходима для проброса GPU.
    

### 1.2. Запуск службы libvirtd

codeBash

```
sudo systemctl enable --now libvirtd.service
```

### 1.3. Добавление пользователя в группу libvirt

Это позволит управлять ВМ без sudo.

codeBash

```
sudo usermod -aG libvirt $(whoami)
```

> [!NOTE] После выполнения этой команды необходимо **выйти из системы и снова войти** или перезагрузить компьютер, чтобы изменения вступили в силу.

---

## Шаг 2: Включение IOMMU и идентификация GPU

### 2.1. Включение IOMMU в BIOS/UEFI

1. Перезагрузите компьютер и войдите в настройки BIOS/UEFI.
    
2. Найдите и включите опции виртуализации:
    
    - **Для Intel:** Intel VT-d, Intel Virtualization Technology.
        
    - **Для AMD:** AMD-Vi, IOMMU, SVM.
        
3. **Важно:** Найдите настройку Primary Display (или Initiate Graphic Adapter) и убедитесь, что выбрана та видеокарта, которая находится в основном слоте PCIe и используется вашим хостом (Arch Linux).
    
4. Сохраните изменения и перезагрузитесь.
    

### 2.2. Активация IOMMU в ядре Linux

1. Отредактируйте конфигурацию загрузчика GRUB:
    
    codeBash
    
    ```
    sudo nano /etc/default/grub
    ```
    
2. Добавьте параметр в строку GRUB_CMDLINE_LINUX_DEFAULT:
    
    - **Для Intel:** intel_iommu=on
        
    - **Для AMD:** amd_iommu=on
        
    
    Пример для Intel:
    
    codeDiff
    
    ```
    - GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
    + GRUB_CMDLINE_LINUX_DEFAULT="quiet splash intel_iommu=on"
    ```
    
3. Обновите конфигурацию GRUB и **перезагрузите компьютер**:
    
    codeBash
    
    ```
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    sudo reboot
    ```
    

---

## Шаг 3: Изоляция гостевой GPU

Наша задача — заставить ядро хоста игнорировать вторую видеокарту, передав ее под управление драйвера vfio-pci.

### 3.1. Определение ID гостевой GPU

Выполните команду, чтобы увидеть все PCI-устройства. Найдите видеокарту, которую вы хотите пробросить, и запишите ее ID вида [xxxx:xxxx]. Не забудьте также ID ее аудиоконтроллера.

codeBash

```
lspci -nnk
```

Пример вывода:

codeCode

```
# Карта для хоста (остается на драйвере nvidia)
01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GA104 [GeForce RTX 3070] [10de:2484]
        Kernel driver in use: nvidia

# Карта для гостевой ВМ (ее мы будем изолировать)
0a:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU106 [GeForce RTX 2060] [10de:1f08]
0a:00.1 Audio device [0403]: NVIDIA Corporation TU106 High Definition Audio Controller [10de:10f9]
```

В этом примере ID для изоляции: 10de:1f08 и 10de:10f9.

### 3.2. Настройка vfio-pci

1. Создайте файл конфигурации для modprobe, который укажет vfio-pci "захватить" устройства с нужными ID при загрузке.
    
    codeBash
    
    ```
    sudo nano /etc/modprobe.d/vfio.conf
    ```
    
2. Добавьте в него следующую строку, подставив **ваши ID**:
    
    codeCode
    
    ```
    options vfio-pci ids=10de:1f08,10de:10f9
    ```
    
3. Пересоберите initramfs, чтобы изменения применились на раннем этапе загрузки, и перезагрузитесь.
    
    codeBash
    
    ```
    sudo mkinitcpio -P
    sudo reboot
    ```
    

### 3.3. Проверка изоляции

После перезагрузки снова выполните lspci -nnk. Результат должен быть таким:

- У вашей **основной (хостовой) GPU** драйвер должен быть nvidia.
    
- У вашей **вторичной (гостевой) GPU** драйвер должен быть vfio-pci.
    

Если это так, вы готовы к созданию ВМ.

---

## Шаг 4: Создание и настройка виртуальной машины

1. Запустите virt-manager из меню приложений или командой в терминале.
    
2. Нажмите "Файл" -> "Создать виртуальную машину".
    
3. Выберите **"Локальный установочный носитель"** и укажите путь к ISO-образу NixOS.
    
4. Выделите ОЗУ (рекомендуется 8 ГБ+) и ядра ЦП.
    
5. Создайте виртуальный жесткий диск.
    
6. **Очень важно:** на последнем шаге поставьте галочку **"Настроить конфигурацию перед установкой"**.
    
7. В открывшемся окне настроек:
    
    - **Обзор** -> Убедитесь, что "Микропрограмма" установлена в **UEFI x86_64**.
        
    - **Процессор** -> Поставьте галочку "Копировать конфигурацию ЦП хоста".
        
    - Удалите все виртуальные устройства отображения: **"Дисплей Spice"** и **"Видео QXL"**.
        
    - Нажмите **"Добавить оборудование"** -> **"Устройство PCI хоста"**.
        
    - Найдите и добавьте вашу гостевую видеокарту (ту, что на vfio-pci).
        
    - Снова нажмите "Добавить оборудование" и добавьте ее аудиоустройство.
        

---

## Шаг 5: Установка и настройка NixOS (внутри ВМ)

1. Нажмите **"Начать установку"** в virt-manager. Изображение должно появиться на мониторе, подключенном ко второй (гостевой) видеокарте.
    
2. Следуйте стандартной процедуре установки NixOS (разметка диска, генерация конфига).
    
3. **Перед перезагрузкой** после установки (nixos-install), отредактируйте файл конфигурации NixOS:
    
    codeBash
    
    ```
    nano /mnt/etc/nixos/configuration.nix
    ```
    
4. Добавьте в него строки для установки драйверов NVIDIA:
    
    codeNix
    
    ```
    # Включить OpenGL и драйверы NVIDIA
    services.xserver.videoDrivers = [ "nvidia" ];
    hardware.opengl.enable = true;
    
    # Рекомендуется для новых карт
    hardware.nvidia.modesetting.enable = true;
    ```
    
5. Сохраните файл, выйдите из chroot и перезагрузите ВМ. NixOS должна запуститься с полным доступом к проброшенной видеокарте.
    

> [!SUCCESS] Готово!  
> Ваш хост Arch Linux продолжает работать на одной видеокарте, в то время как виртуальная машина NixOS имеет эксклюзивный доступ ко второй.