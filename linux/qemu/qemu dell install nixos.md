


# Установка NixOS + Hyprland в KVM/QEMU (BTRFS Edition)

**Теги:** #linux #nixos #hyprland #kvm #btrfs # obsidian-install-guide

Эта заметка описывает полный процесс установки и настройки [[NixOS]] с [[Hyprland]] в виртуальной машине KVM/QEMU с использованием файловой системы [[BTRFS]].

## Часть 1: Подготовка хост-машины и KVM

> **Цель:** Подготовить среду виртуализации, чтобы избежать проблем с правами доступа и сетью.

1. **Проверка прав пользователя:** Убедиться, что пользователь состоит в группе libvirt.
    
    codeBash
    
    ```
    # Проверить группы
    groups $USER
    # Добавить, если нужно (требуется перезаход в систему!)
    sudo usmod -aG libvirt $USER
    ```
    
2. **Проверка служб KVM:** Включить и запустить службу libvirtd.
    
    codeBash
    
    ```
    sudo systemctl enable --now libvirtd.service
    ```
    
3. **Подготовка ISO-образа:** Переместить установочный образ NixOS в директорию, доступную для libvirt, чтобы избежать ошибок Permission denied и Guest is not running.
    
    codeBash
    
    ```
    sudo mv ~/Downloads/nixos-*.iso /var/lib/libvirt/images/
    ```
    

## Часть 2: Создание и настройка виртуальной машины

> **Цель:** Создать правильно сконфигурированную ВМ, способную загрузить установщик и поддерживать Hyprland в будущем.

Используем virt-manager для создания новой ВМ со следующими ключевыми параметрами:

1. **Способ установки:** "Локальный установочный носитель", указать путь к ISO в /var/lib/libvirt/images/.
    
2. **Ресурсы:**
    
    - **RAM:** 4096 MB
        
    - **CPU:** 4 ядра
        
3. **Диск:** 30 GB
    
4. **Финальные настройки (включить "Настроить конфигурацию перед установкой"):**
    
    - **Сеть:** Виртуальная сеть 'default' : NAT (так как хост подключен по Wi-Fi).
        

### Тонкая настройка оборудования (до первого запуска)

- **Обзор -> Микропрограмма:** UEFI x86_64... (выбрать вариант **без** secboot, если возникают проблемы).
    
- **Параметры загрузки:**
    
    Включить SATA CDROM 1.
    
    - Переместить SATA CDROM 1 на **первое место** в списке.
        
- **SATA CDROM 1:**
    
    - **Путь к источнику:** Убедиться, что путь к ISO-образу **указан**. Это была причина ошибки Please select boot device.
        
- **Видео:** Изначально для установки использовалась "безопасная" конфигурация, чтобы победить черный экран.
    
    - **Модель:** QXL
        
    - **Ускорение 3D:** [ ] (отключено на время установки).
        
    
    > **Примечание:** После успешной установки системы эти параметры нужно будет изменить на **VirtIO** и **включить 3D-ускорение** для работы Hyprland.
    
- **Ввод:**
    
    - Удалить Мышь PS/2.
        
    - Добавить Графический планшет EvTouch USB для корректной работы курсора.
        

## Часть 3: Удаленное подключение и установка

> **Цель:** Установить систему комфортно через SSH, используя tmux.

1. **Запуск ВМ:** После всех настроек ВМ успешно загружается с ISO и показывает меню установщика.
    
2. **Настройка Live-среды для SSH:**
    
    - Загрузиться в live-режим (нажать Enter).
        
    - Узнать IP-адрес ВМ: ip a (будет вида 192.168.122.x).
        
    - Задать временный пароль: passwd.
        
    - Запустить SSH-сервер: sudo systemctl start sshd.
        
3. **Настройка SSH-подключения:**
    
    - **Проблема:** Прямое подключение к хосту по паролю не работало, так как на нем разрешен вход только по ключам.
        
    - **Решение:** Использовать SSH-ключ для "прыжка" (ProxyJump).
        
    - **Конфиг ~/.ssh/config на основной машине:**
        
        codeCode
        
        ```
        Host hyrip-server
          HostName 192.168.100.6 # IP хоста (где KVM)
          User hyrip
          IdentityFile ~/.ssh/hyrip_local_key
        ```
        
    - **Копирование ключа (если не сделано ранее):**
        
        codeBash
        
        ```
        ssh-copy-id hyrip-server
        ```
        
    - **Команда для подключения к ВМ:**
        
        codeBash
        
        ```
        ssh -J hyrip-server nixos@192.168.122.244 # IP ВМ из команды 'ip a'
        ```
        
4. **Проблема No route to host:**
    
    - **Причина:** Файрвол на хост-машине Arch блокировал соединение между хостом и виртуальной сетью libvirt.
        
    - **Решение (на хосте Arch):** Добавить виртуальный интерфейс virbr0 в доверенную зону firewalld.
        
        codeBash
        
        ```
        sudo firewall-cmd --zone=trusted --add-interface=virbr0 --permanent
        sudo firewall-cmd --reload
        ```
        

## Часть 4: Процесс установки NixOS на BTRFS

> **Цель:** Разметить диск и установить систему с базовой конфигурацией для Hyprland на файловую систему BTRFS.

Все команды выполняются внутри SSH-сессии с ВМ под root (sudo -i).

1. **Разметка диска (/dev/vda):** Создаем всего два раздела.
    
    codeBash
    
    ```
    # Создаем новую GPT-таблицу разделов
    parted /dev/vda -- mklabel gpt
    # EFI-раздел (512MB)
    parted /dev/vda -- mkpart ESP fat32 1MiB 513MiB
    parted /dev/vda -- set 1 boot on
    # Корневой раздел BTRFS (все остальное место)
    parted /dev/vda -- mkpart root btrfs 513MiB 100%
    ```
    
2. **Форматирование:**
    
    codeBash
    
    ```
    # Форматируем EFI-раздел в FAT32
    mkfs.fat -F 32 /dev/vda1
    # Форматируем корневой раздел в BTRFS
    mkfs.btrfs /dev/vda2
    ```
    
3. **Создание BTRFS subvolumes (подтомов):** Это "правильный" способ организации системы на BTRFS. Мы создадим отдельные подтома для корня (@) и домашней директории (@home).
    
    codeBash
    
    ```
    # Сначала монтируем BTRFS-раздел верхнего уровня
    mount /dev/vda2 /mnt
    # Создаем подтома
    btrfs subvolume create /mnt/@
    btrfs subvolume create /mnt/@home
    # Отмонтируем раздел верхнего уровня
    umount /mnt
    ```
    
    > **Опционально: SWAP-раздел.** Если вы все же хотите использовать SWAP, создайте и отформатируйте его на шаге 1 и 2 (/dev/vda3), а затем включите командой swapon /dev/vda3.
    
4. **Монтирование с subvolumes:** Теперь монтируем подтома в правильные места.
    
    codeBash
    
    ```
    # Монтируем корневой подтом с опциями для BTRFS
    mount -o subvol=@,compress=zstd,noatime /dev/vda2 /mnt
    # Создаем точки монтирования для /home и /boot
    mkdir -p /mnt/home
    mkdir -p /mnt/boot
    # Монтируем домашний подтом
    mount -o subvol=@home,compress=zstd,noatime /dev/vda2 /mnt/home
    # Монтируем EFI-раздел
    mount /dev/vda1 /mnt/boot
    ```
    
5. **Генерация конфига:**
    
    codeBash
    
    ```
    nixos-generate-config --root /mnt
    ```
    
6. **Редактирование configuration.nix:**
    
    - Открываем nano /mnt/etc/nixos/configuration.nix.
        
    - **Важные исправления по ходу:**
        
        - Добавить { config, pkgs, ... }: в самом начале файла, чтобы исправить ошибку undefined variable 'pkgs'.
            
        - Добавить services.displayManager.sddm.wayland.enable = true; чтобы исправить ошибку Failed assertions: - SDDM requires ....
            
        - Переименовать noto-fonts-cjk в noto-fonts-cjk-sans в списке пакетов.
            
    - Здесь можно вставить финальный рабочий configuration.nix.
        
7. **Установка:**
    
    codeBash
    
    ```
    nixos-install
    ```
    
8. **Первая перезагрузка:**
    
    - reboot
        
    - **Критически важно:** В virt-manager зайти в настройки ВМ и в "Параметрах загрузки" **отключить CD-ROM**, чтобы ВМ загрузилась с установленной системы.
        
9. **Пост-установка:**
    
    - Войти в систему (пароль пустой).
        
    - Открыть терминал (Super+Enter).
        
    - Задать пароль пользователя: passwd.