
# VM План для ASUS ROG Strix G731U: Запуск NixOS + Hyprland

**Теги:** #virtualization #kvm #asus_rog #vfio #nixos #hyprland #virtio_3d

> [!WARNING] Важный вердикт по пробросу GPU
> На этом ноутбуке **полноценный проброс GPU (VFIO Passthrough) теоретически возможен**, но это **экспертная задача** со своими сложностями (режим Single GPU, "черный экран" хоста, необходимость SSH).
>
> **Рекомендуется начать с более простого и надежного метода.**

---

### Проблема: Почему Hyprland не запускался раньше?

Hyprland — это современный Wayland-композитор, который для своей работы **требует аппаратного 3D-ускорения** (поддержку OpenGL). Стандартная виртуальная машина предоставляет лишь базовую 2D "видеокарту-заглушку" (модель QXL), которая не умеет в 3D. Hyprland, не найдя нужной поддержки, аварийно завершает работу.

### План А (Рекомендуемый): Виртуальное 3D-ускорение

Это самый быстрый и надежный способ запустить Hyprland в ВМ для тестирования и настройки. Мы настроим QEMU для "проброса" 3D-команд на вашу хост-систему.

*   **Преимущества:** Простота настройки, не требует сложной диагностики, хост-система всегда доступна.
*   **Недостатки:** Производительность ниже, чем при полном пробросе, но достаточная для комфортной работы с интерфейсом.

### План Б (Экспертный): Полный проброс GPU

Этот путь стоит выбирать, только если вам нужна максимальная производительность в ВМ (например, для игр) и вы готовы к сложной настройке.

*   **Требования:** Наличие MUX-свитча, чистые IOMMU-группы, настройка SSH для управления "слепым" хостом.

---

### Пошаговый план действий (по Плану А)

#### Шаг 1: Настройка хоста (Arch Linux)

1.  **Установка KVM/QEMU и утилит:**
    ```bash
    sudo pacman -S qemu-full virt-manager virt-viewer libguestfs
    ```
2.  **Запуск службы `libvirtd`:**
    ```bash
    sudo systemctl enable --now libvirtd.service
    ```
3.  **Добавление пользователя в группу `libvirt`:**
    ```bash
    sudo usermod -aG libvirt $(whoami)
    ```
    > [!NOTE] После этого необходимо **выйти из системы и снова войти**.

#### Шаг 2: Создание и настройка ВМ для NixOS + Hyprland

1.  Запустите `virt-manager`.
2.  Начните создание новой ВМ, указав ISO-образ NixOS.
3.  Выделите 4+ ядра ЦП и 8+ ГБ ОЗУ.
4.  **Очень важно:** на последнем шаге поставьте галочку **"Настроить конфигурацию перед установкой"**.
5.  В открывшемся окне настроек:
    *   Перейдите в раздел **"Видео"**.
    *   Измените **"Модель"** с `QXL` на **`Virtio`**.
    *   Поставьте галочку **"3D-ускорение"** (`Enable 3D acceleration`).
    *   Перейдите в раздел **"Дисплей Spice"**.
    *   В поле **"Listen Type"** выберите **"None"**. Это важно для работы 3D.
6.  Начните установку. После установки NixOS и Hyprland, он должен успешно запуститься.

#### Шаг 3: ВМ для Windows (Электронная подпись)

*   Создайте еще одну, стандартную ВМ для Windows. **Никаких специальных настроек графики для нее не требуется**.
*   Для работы с USB-токеном используйте меню "Виртуальная машина" -> "Перенаправить USB-устройство" в `virt-manager`.