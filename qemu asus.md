
# План виртуализации для ASUS ROG Strix G731U

**Теги:** #virtualization #kvm #asus #vfio #gpu_passthrough #nixos #windows_vm

> [!WARNING] Важный вердикт: Проброс видеокарты (GPU Passthrough)
> На этом ноутбуке проброс дискретной видеокарты **технически возможен**, но является **крайне сложной задачей** и подходит только для экспертов.
> **Ключевые моменты:**
> 1.  **Требуется MUX Switch:** Успех зависит от возможности переключить ноутбук в режим "только дискретная GPU" (`dGPU only` / `Ultimate`) в программе Armoury Crate или в UEFI.
> 2.  **Сценарий Single GPU Passthrough:** При запуске ВМ хост-система (Arch Linux) потеряет доступ к графике, и **экран погаснет**. Управление хостом будет возможно только по **SSH** с другого устройства.
>
> **Рекомендация:** Начните с базовой виртуализации. Попытку проброса GPU стоит предпринимать, только если вы полностью осознаете все сложности.

---

## План А: Рекомендуемый (безопасный) сценарий

Этот план аналогичен плану для Dell и покрывает все ваши потребности без лишних сложностей.

### 1. Настройка NixOS и Windows в стандартных ВМ
*   **Цель:** Изучить NixOS и использовать Windows для электронной подписи.
*   **Метод:** Использовать KVM/QEMU без проброса GPU. Для Windows это идеальный вариант. Для NixOS этого достаточно для изучения системы.

### 2. Пошаговая инструкция
Инструкция полностью идентична той, что для Dell Inspiron:
1.  Установите пакеты KVM/QEMU.
2.  Запустите службу `libvirtd`.
3.  Добавьте пользователя в группу `libvirt`.
4.  Создайте стандартные ВМ для NixOS и Windows в `virt-manager`.
5.  Для Windows используйте функцию "Перенаправить USB-устройство" для работы с токеном.

---

## План Б: Продвинутый (экспертный) сценарий: Проброс GPU в NixOS

> [!DANGER] Внимание!
> Не приступайте к этому плану, не выполнив предварительную диагностику. Вы должны быть готовы к тому, что хост станет "слепым" во время работы ВМ.

### Шаг 0: Чек-лист для диагностики

1.  **Проверка MUX Switch:**
    *   Найдите в Armoury Crate или UEFI настройку режима GPU. Переключите ее в `Ultimate` или `dGPU only`. Если такой опции нет, **проброс невозможен**.

2.  **Настройка UEFI:**
    *   Включите `Intel Virtualization Technology (VT-d)`.
    *   Отключите `Secure Boot`.

3.  **Проверка групп IOMMU:**
    *   Загрузитесь в Arch, добавьте `intel_iommu=on` в параметры ядра и перезагрузитесь.
    *   Выполните скрипт:
      ```bash
      for d in /sys/kernel/iommu_groups/*/devices/*; do n=${d#*/iommu_groups/*}; n=${n%%/*}; printf 'IOMMU Group %s ' "$n"; lspci -nns "${d##*/}"; done | sort -V
      ```
    *   Убедитесь, что ваша видеокарта NVIDIA и ее аудиоустройство находятся в **изолированной группе** без других важных устройств.

### Дальнейшие действия
*   **Если все пункты чек-листа выполнены успешно,** вы можете следовать полному руководству по настройке **Single GPU Passthrough**. Оно включает изоляцию GPU через `vfio-pci`, настройку `libvirt hooks` для отвязки GPU от хоста при запуске ВМ, и настройку SSH-доступа.
*   **Для ВМ с Windows:** Продолжайте использовать ее в стандартном режиме без проброса. Ей не нужен доступ к мощной видеокарте для вашей задачи.