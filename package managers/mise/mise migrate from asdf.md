# Миграция с ASDF на Mise на Arch Linux

## Почему переходим?

mise (ранее rtx) — это современная, быстрая и удобная замена для asdf.

- **Скорость:** Ядро на Go/Rust значительно быстрее, чем asdf на Bash. Отклик терминала становится мгновенным.
    
- **Удобство:** mise автоматически устанавливает недостающие инструменты при заходе в директорию (не нужно вручную запускать install).
    
- **Надежность на Arch:** mise находится в официальных репозиториях (extra), в то время как asdf из AUR (asdf-vm) может быть нестабилен.
    
- **Совместимость:** mise на 100% совместим с файлами .tool-versions и плагинами asdf.
    

---

## Пошаговый план миграции

### 1. Полная очистка от asdf

> **Цель:** Убрать старый менеджер и его конфигурацию, чтобы избежать конфликтов.

1. **Удалить системный пакет asdf:**
    
    codeBash
    
    ```
    yay -Rns asdf-vm
    ```
    
2. **Очистить .zshrc:**
    
    - Открыть ~/.zshrc в редакторе.
        
    - Найти и полностью удалить строки, связанные с asdf.
        
3. **Сделать бекап установленных версий (опционально, но рекомендуется):**
    
    - Если директория ~/.asdf существует (от ручной установки), переименовать её:
        
        codeBash
        
        ```
        mv ~/.asdf ~/.asdf_backup
        ```
        

### 2. Установка и настройка mise

> **Цель:** Установить mise и интегрировать его в рабочую оболочку.

1. **Установить mise из официальных репозиториев:**
    
    codeBash
    
    ```
    yay -S mise
    ```
    
2. **Активировать mise в .zshrc:**
    
    - Убедиться, что следующая строка находится **в самом конце** файла ~/.zshrc для гарантии приоритета:
        
        codeBash
        
        ```
        # mise - modern, fast tool version manager
        eval "$(mise activate zsh)"
        ```
        
    - Можно добавить её командой:
        
        codeBash
        
        ```
        echo -e '\n# mise - modern, fast tool version manager\neval "$(mise activate zsh)"' >> ~/.zshrc
        ```
        
3. **Применить изменения:**
    
    - **Полностью перезапустить все окна терминала** или выполнить в каждом:
        
        codeBash
        
        ```
        source ~/.zshrc
        ```
        

### 3. Восстановление инструментов

> **Цель:** Переустановить все необходимые версии ПО с помощью нового менеджера.

1. **Зайти в любую директорию проекта** с файлом .tool-versions.
    
2. **Запустить установку:**
    
    codeBash
    
    ```
    mise install
    ```
    

> ⚠️ **Внимание!** Если вы используете инструменты со старыми или больше не поддерживаемыми плагинами (яркий пример — **pnpm**), mise install может завершиться с ошибкой. В этом случае переходите к разделу **Решение проблем** ниже.

---

## Решение проблем: случай со старым pnpm

> **Проблема:** Некоторые плагины asdf (например, для pnpm) были удалены с GitHub. mise не может их скачать, и установка прерывается. Старые версии pnpm также не имеют удобной команды pnpm setup.

**Решение:** Не управлять pnpm через mise. Вместо этого управлять версией Node.js через mise, а pnpm устанавливать как локальную зависимость проекта и использовать "умный" алиас.

#### Шаг 1: Исправить .tool-versions

1. Откройте файл .tool-versions в проблемном проекте.
    
2. **Удалите** оттуда строку pnpm X.Y.Z.
    
3. Убедитесь, что строка для node корректна (используйте node, а не nodejs).
    
    codeDiff
    
    ```
    - nodejs 10.24.1
    - pnpm 5.18.10
    + node 10.24.1
    ```
    
4. Снова запустите установку. Теперь mise установит только node.
    
    codeBash
    
    ```
    mise install
    ```
    

#### Шаг 2: Установить pnpm локально

1. **Удалите старые артефакты**, если они остались от неудачных попыток:
    
    codeBash
    
    ```
    rm -rf node_modules package-lock.json
    ```
    
2. Запустите установку зависимостей, **явно указав версию pnpm для npx**. Это нужно сделать только один раз для "загрузки" node_modules.
    
    codeBash
    
    ```
    # Замените 5.18.10 на нужную вам версию
    npx pnpm@5.18.10 install
    ```
    

#### Шаг 3: Настроить удобный алиас (раз и навсегда)

Поскольку в старых версиях pnpm нет команды setup, создадим универсальный алиас.

1. Откройте ~/.zshrc.
    
2. В секцию, где хранятся ваши алиасы, добавьте:
    
    codeBash
    
    ```
    # Универсальный вызов pnpm через npx, работает для любой версии в любом проекте
    alias pnpm='npx pnpm'
    ```
    
3. **Перезапустите терминал** или выполните source ~/.zshrc.
    

Теперь вы можете просто и привычно использовать pnpm install, pnpm start и т.д. во всех проектах.

---

### 4. Финальная очистка

> **Цель:** Удалить старые, больше не нужные файлы.

- После того как вы убедились, что mise работает и все проекты запускаются, можно безопасно удалить бекап:
    
    codeBash
    
    ```
    rm -rf ~/.asdf_backup
    ```