
---
tags:
  - php
  - ddev
  - composer
  - security
  - phpmailer
  - troubleshooting
---
# Настройка PHPMailer с SMTP через .env и Composer (в DDEV)

Эта заметка описывает процесс переноса настроек SMTP (логин, пароль) из PHP-кода в безопасный, игнорируемый Git'ом `.env` файл. Используется стандартный подход с Composer и библиотекой `phpdotenv` в среде DDEV для легаси-проектов.

## Цель
- Убрать пароли и другие секретные данные из-под контроля версий (Git).
- Сделать конфигурацию проекта гибкой для разных окружений (локальное, продакшн).
- Использовать современные стандартные практики даже в старых проектах.

---

## 1. Установка зависимостей через Composer

> [!info] Composer в DDEV
> Вам не нужно устанавливать PHP или Composer на ваш основной компьютер. DDEV предоставляет все необходимые инструменты внутри контейнера.

1.  **Убедитесь, что DDEV-проект запущен:**
    ```bash
    ddev start
    ```

2.  **Добавьте библиотеку `phpdotenv`:**
    Выполните эту команду в терминале, находясь в корневой папке проекта.
    ```bash
    ddev composer require vlucas/phpdotenv
    ```
    Эта команда автоматически создаст/обновит файлы `composer.json`, `composer.lock` и создаст папку `vendor/` со всеми зависимостями.

---

## 2. Настройка конфигурационных файлов

### 2.1. Создание `.env` (Секретный файл)
Создайте в корне проекта файл `.env`. **Этот файл никогда не должен попадать в Git.**

```ini
# .env
SMTP_HOST="smtp.yandex.ru"
SMTP_PORT=465
SMTP_USERNAME="your-login@yandex.ru"
SMTP_PASSWORD="your_secret_password_from_yandex"
```

### 2.2. Создание `.env.example` (Шаблон для Git)
Создайте копию `.env` с пустыми значениями. Этот файл будет служить примером для настройки проекта на другой машине. **Этот файл нужно добавить в Git.**

```ini
# .env.example
SMTP_HOST="smtp.your-provider.com"
SMTP_PORT=465
SMTP_USERNAME=""
SMTP_PASSWORD=""
```

### 2.3. Обновление `.gitignore`
Убедитесь, что ваш `.gitignore` содержит правила для игнорирования секретного файла и папки с зависимостями.

> [!danger] ВАЖНО: Убедитесь, что файл `.env` и папка `/vendor/` добавлены в `.gitignore` ДО коммита!

```gitignore
# .gitignore

# ... другие правила

# Конфиденциальные данные
.env
.env.*
!.env.example

# Зависимости Composer
/vendor/

# ... другие правила
```

---

## 3. Модификация PHP-кода (`mailer/smart.php`)

Нужно изменить PHP-скрипт так, чтобы он читал настройки из `.env` файла, а не из жестко прописанных переменных.

```php
<?php
// mailer/smart.php

// 1. Подключаем автозагрузчик Composer
// Он сам найдет и подключит все нужные библиотеки из папки vendor/
require_once __DIR__ . '/../vendor/autoload.php';

// 2. Загружаем переменные из .env в окружение PHP
// __DIR__ . '/..' указывает на корневую папку проекта (на один уровень выше, чем 'mailer')
$dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

// 3. Используем переменные в коде PHPMailer
// ... ваш код инициализации PHPMailer ...
try {
    $mail = new PHPMailer(true);
    $mail->CharSet = 'UTF-8';
    $mail->isSMTP();
    $mail->SMTPAuth = true;

    // Используем переменные, загруженные из .env, через суперглобальный массив $_ENV
    $mail->Host       = $_ENV['SMTP_HOST'];
    $mail->Username   = $_ENV['SMTP_USERNAME'];
    $mail->Password   = $_ENV['SMTP_PASSWORD'];
    $mail->Port       = $_ENV['SMTP_PORT'];
    $mail->SMTPSecure = 'ssl'; // Это значение редко меняется, можно оставить

    // ... остальной код отправки письма ...

} catch (Exception $e) {
    // ... обработка ошибок ...
}
```

---

## 4. Сохранение изменений в Git

После всех изменений, добавьте в Git только безопасные файлы.

```bash
# 1. Добавляем измененный скрипт, шаблон .env, обновленный .gitignore и файлы Composer
git add mailer/smart.php .env.example .gitignore composer.json composer.lock

# 2. Делаем коммит
git commit -m "feat: Externalize mailer config to .env file"

# 3. Отправляем на удаленный репозиторий
git push
```

---

## 5. Развертывание на Shared-хостинге (без SSH и Composer)

На большинстве shared-хостингов нет доступа к командной строке для запуска Composer. В этом случае весь проект готовится локально, а на сервер загружается уже полностью готовая версия.

### Шаг 1: Локальная подготовка проекта

Перед загрузкой на сервер, установите все production-зависимости на своем компьютере.

1. Откройте терминал в корне проекта.
    
2. Выполните команду:
    
    codeBash
    
    ```
    ddev composer install --no-dev --optimize-autoloader
    ```
    
    - **install**: Устанавливает точные версии библиотек из composer.lock.
        
    - **--no-dev**: Пропускает установку пакетов, нужных только для разработки (например, для тестов), уменьшая размер проекта.
        
    - **--optimize-autoloader**: Создает оптимизированный файл автозагрузки для более быстрой работы на продакшене.
        

После выполнения этой команды ваша папка vendor/ будет полностью готова к работе на сервере.

### Шаг 2: Загрузка файлов на хостинг

Подключитесь к вашему хостингу по FTP, SFTP или через файловый менеджер в панели управления.

1. Загрузите все файлы вашего проекта на сервер.
    
2. **Обязательно загрузите папку vendor/ целиком.** Именно в ней содержатся все библиотеки, которые нужны вашему PHP-скрипту для работы.
    

### Шаг 3: Настройка .env на сервере

> [!warning] Никогда не загружайте ваш локальный .env файл на сервер! В нем содержатся настройки для разработки, а не для продакшена.

1. Используя файловый менеджер хостинга, создайте в корневой директории вашего сайта на сервере новый файл с именем .env.
    
2. Откройте его для редактирования.
    
3. Скопируйте содержимое вашего .env.example и вставьте в новый .env на сервере, указав уже **реальные ("боевые")** данные для SMTP-сервера.
    

Теперь ваш PHP-скрипт на сервере будет использовать тот же код, но подхватит конфигурацию из "боевого" .env файла.

---

## 6. Возможные проблемы и их решение

### Проблема: DDEV не запускается с сетевой ошибкой
Вы пытаетесь запустить `ddev start`, но получаете ошибку, связанную с сетью Docker.

> [!bug] Текст ошибки:
> `Failed to RunSimpleContainer... failed to set up container networking... operation not supported`

-   **Причина:** Чаще всего возникает на Arch Linux / EndeavourOS после обновления системы (`sudo pacman -Syu`), в ходе которого было обновлено ядро Linux. Система продолжает работать на старом ядре в памяти, в то время как модули на диске уже обновлены до новой версии. Это вызывает конфликт, когда Docker пытается создать виртуальную сеть.
-   **Решение:** **Перезагрузите компьютер.** Это самый надежный способ, который синхронизирует работающее ядро с модулями на диске. В 95% случаев это решает проблему.
-   **Быстрая проверка перед перезагрузкой:** Иногда помогает простой перезапуск службы Docker.
    ```bash
    sudo systemctl restart docker
    ```