# Заметка: Временный "патч" для Custom Field Suite (CFS) в WordPress

**Предупреждение:** Это *временное* и *ограниченное* решение для снижения рисков устаревшего и небезопасного плагина Custom Field Suite (CFS). Лучшее долгосрочное решение - **миграция на поддерживаемую альтернативу** (например, Pods, Meta Box).

## Контекст

*   **Проблема:** Плагин CFS больше не поддерживается и содержит известные уязвимости (SQL Injection, XSS, CSRF, Privilege Escalation, потенциальный `eval`).
*   **Цель заплатки:** Ограничить доступ к потенциально опасным функциям CFS для пользователей без прав администратора (`activate_plugins`), особенно отключив тип поля `loop`.
*   **Сценарий использования:** Подходит для сайтов с **закрытой регистрацией**, **закрытыми комментариями** и **одним администратором**.

## Инструкция по применению

1.  **Создайте файл заплатки:**
    *   Откройте текстовый редактор (убедитесь, что он сохраняет файлы в кодировке UTF-8 без BOM).
    *   Скопируйте и вставьте **весь** код из раздела `## Файл заплатки (cfs-lock.php)` ниже.
    *   Сохраните файл как `cfs-lock.php`.

2.  **Разместите файл в директории `mu-plugins`:**
    *   Найдите директорию `wp-content` на вашем сервере (обычно находится в корне установки WordPress).
    *   Внутри `wp-content` создайте новую папку с именем `mu-plugins`, если её ещё нет.
    *   Загрузите созданный файл `cfs-lock.php` внутрь папки `wp-content/mu-plugins`.

3.  **Проверка:**
    *   Убедитесь, что плагин CFS всё ещё активен.
    *   Войдите в админ-панель WordPress под пользователем, **не** обладающим правами `activate_plugins`.
    *   Проверьте, исчезло ли меню "Custom Fields" (или аналогичное) и перестали ли работать функции, связанные с типом поля `loop` (если они были настроены).
    *   Проверьте, не возникает ли ошибок на сайте или в логах PHP.

## Файл заплатки (cfs-lock.php)

Создайте файл `wp-content/mu-plugins/cfs-lock.php` со следующим содержимым:

```php
<?php
/**
 * Plugin Name: CFS security lock
 * Description: Отключает опасные части CFS для всех, кто не может управлять плагинами.
 *              Это ВРЕМЕННОЕ решение. Пожалуйста, мигрируйте на поддерживаемую альтернативу.
 */

add_action('plugins_loaded', 'cfs_lock_down', 0);

function cfs_lock_down() {
    // Проверяем, есть ли у текущего пользователя право активировать плагины
    if (!current_user_can('activate_plugins')) {
        // 1. Пытаемся удалить пункт меню CFS в админ-панели
        add_action('admin_menu', function () {
            remove_menu_page('edit.php?post_type=cfs');
        }, 999); // Высокий приоритет, чтобы сработать после CFS

        // 2. Пытаемся отключить тип поля 'loop' до его регистрации (если используется фильтр)
        add_filter('cfs_field_types', function ($types) {
            unset($types['loop']);
            return $types;
        }, 999); // Высокий приоритет, чтобы сработать до CFS

        // 3. Пытаемся отключить потенциально опасные AJAX-действия CFS
        //    Обратите внимание: это может не сработать, если CFS использует другие названия хуков
        $cfs_ajax_actions = [
            'cfs_get_field',
            'cfs_save_field',
            'cfs_delete_field',
            // Добавьте сюда другие известные AJAX-действия CFS, если необходимо
        ];

        foreach ($cfs_ajax_actions as $action) {
            add_action("wp_ajax_$action", '__return_false', PHP_INT_MAX); // Для авторизованных
            add_action("wp_ajax_nopriv_$action", '__return_false', PHP_INT_MAX); // Для неавторизованных
        }
    }
}